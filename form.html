function doPost(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // Check if FormData or JSON
  let data = {};
  let isFormData = false;
  try {
    data = JSON.parse(e.postData.contents);
  } catch (err) {
    isFormData = true;
    data = e.parameter;
  }
  const action = data.action;

  if (action === "add_meeting" || action === "edit_meeting") {
    const sheet = ss.getSheetByName("Meetings");
    if (action === "add_meeting") {
      const id = generateNextMeetingID(sheet);
      data.meetingId = id;

      let fileUrl = "";
      if (isFormData && e.postData && e.postData.length > 0) {
        const blob = e.postData.getAs("application/octet-stream");
        const folder = DriveApp.getFolderById("1Yz4uaedg3Ako_KPP9FKqCuZq1kiGLo1p");  // ðŸ‘ˆ Replace with your folder ID
        const file = folder.createFile(blob);
        fileUrl = file.getUrl();
      }

      sheet.appendRow([
        id, data.meetingDate, data.zone, data.district, data.coldRoom,
        data.meetingTitle, data.conductedBy, data.attendees,
        data.meetingAgenda, data.meetingDiscussion, fileUrl
      ]);
      return ContentService.createTextOutput(JSON.stringify({ message: "Meeting saved.", meetingId: id })).setMimeType(ContentService.MimeType.JSON);
    } else if (data.row) {
      const rowNum = Number(data.row);
      if (!rowNum || rowNum < 2) {
        return ContentService.createTextOutput("Invalid row number").setMimeType(ContentService.MimeType.TEXT);
      }

      let fileUrl = data.photoUrl || "";
      if (isFormData && e.postData && e.postData.length > 0) {
        const folder = DriveApp.getFolderById("1Yz4uaedg3Ako_KPP9FKqCuZq1kiGLo1p");  // ðŸ‘ˆ Replace with your folder ID
        const blob = e.postData.getAs("application/octet-stream");
        const file = folder.createFile(blob);
        fileUrl = file.getUrl();
      }

      const values = [
        data.meetingId, data.meetingDate, data.zone, data.district, data.coldRoom,
        data.meetingTitle, data.conductedBy, data.attendees,
        data.meetingAgenda, data.meetingDiscussion, fileUrl
      ];
      sheet.getRange(rowNum, 1, 1, values.length).setValues([values]);
      return ContentService.createTextOutput(JSON.stringify({ message: "Meeting updated.", meetingId: data.meetingId })).setMimeType(ContentService.MimeType.JSON);
    }
  }

  if (action === "delete_meeting") {
    const sheet = ss.getSheetByName("Meetings");
    const rowNum = Number(data.row);
    if (rowNum > 1) {
      sheet.deleteRow(rowNum);
      return ContentService.createTextOutput("Meeting deleted.").setMimeType(ContentService.MimeType.TEXT);
    }
  }

  if (action === "add_action" || action === "edit_action") {
    const sheet = ss.getSheetByName("Action Items");

    const values = [
      data.meetingId, data.actionItem,
      data.assignedTo, data.deadline, data.status
    ];

    if (action === "add_action") {
      sheet.appendRow(values);
      return ContentService.createTextOutput("Action item added.").setMimeType(ContentService.MimeType.TEXT);
    } else if (data.row) {
      const rowNum = Number(data.row);
      if (!rowNum || rowNum < 2) {
        return ContentService.createTextOutput("Invalid row number").setMimeType(ContentService.MimeType.TEXT);
      }
      sheet.getRange(rowNum, 1, 1, values.length).setValues([values]);
      return ContentService.createTextOutput("Action item updated.").setMimeType(ContentService.MimeType.TEXT);
    }
  }

  if (action === "delete_action") {
    const sheet = ss.getSheetByName("Action Items");
    const rowNum = Number(data.row);
    if (rowNum > 1) {
      sheet.deleteRow(rowNum);
      return ContentService.createTextOutput("Action item deleted.").setMimeType(ContentService.MimeType.TEXT);
    }
  }

  return ContentService.createTextOutput("Invalid request.")
    .setMimeType(ContentService.MimeType.TEXT);
}

function doGet(e) {
  const sheetName = e.parameter.sheet;
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  const data = sheet.getDataRange().getValues();
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function generateNextMeetingID(sheet) {
  const prefix = "BCIE-IN-P1-M";
  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return prefix + "001";

  const data = sheet.getRange(2, 1, lastRow - 1).getValues().reverse();
  for (let i = 0; i < data.length; i++) {
    const id = data[i][0];
    if (id && typeof id === 'string' && id.startsWith(prefix)) {
      const num = parseInt(id.replace(prefix, ""));
      if (!isNaN(num)) {
        return prefix + (num + 1).toString().padStart(3, '0');
      }
    }
  }
  return prefix + "001";
}
